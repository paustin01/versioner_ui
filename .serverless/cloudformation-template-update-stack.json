{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "The AWS CloudFormation template for this Serverless application",
  "Resources": {
    "S3AppBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "AccessControl": "Private",
        "VersioningConfiguration": {
          "Status": "Enabled"
        },
        "BucketName": "development-clear-lake-versionator-ui",
        "LoggingConfiguration": {
          "DestinationBucketName": {
            "Ref": "S3AppLogBucket"
          },
          "LogFilePrefix": "versionator-ui"
        },
        "Tags": [
          {
            "Key": "billing-env",
            "Value": "development"
          },
          {
            "Key": "billing-product",
            "Value": "versionator-ui"
          },
          {
            "Key": "billing-type",
            "Value": "data"
          }
        ]
      }
    },
    "S3AppLogBucket": {
      "Type": "AWS::S3::Bucket",
      "Properties": {
        "BucketEncryption": {
          "ServerSideEncryptionConfiguration": [
            {
              "ServerSideEncryptionByDefault": {
                "SSEAlgorithm": "AES256"
              }
            }
          ]
        },
        "AccessControl": "LogDeliveryWrite",
        "VersioningConfiguration": {
          "Status": "Suspended"
        },
        "BucketName": "development-clear-lake-versionator-ui-logs",
        "LifecycleConfiguration": {
          "Rules": [
            {
              "Id": "DeleteContentAfter90Days",
              "Status": "Enabled",
              "ExpirationInDays": 90
            }
          ]
        },
        "Tags": [
          {
            "Key": "billing-env",
            "Value": "development"
          },
          {
            "Key": "billing-product",
            "Value": "devops"
          },
          {
            "Key": "billing-type",
            "Value": "devops"
          }
        ]
      }
    },
    "S3AppBucketPolicy": {
      "Type": "AWS::S3::BucketPolicy",
      "Properties": {
        "Bucket": {
          "Ref": "S3AppBucket"
        },
        "PolicyDocument": {
          "Statement": [
            {
              "Action": "s3:GetObject",
              "Effect": "Allow",
              "Resource": {
                "Fn::Sub": "arn:aws:s3:::${S3AppBucket}/*"
              },
              "Principal": {
                "AWS": {
                  "Fn::Sub": "arn:aws:iam::cloudfront:user/CloudFront Origin Access Identity ${CloudFrontOriginAccessIdentity}"
                }
              }
            }
          ]
        }
      }
    },
    "CloudFrontOriginAccessIdentity": {
      "Type": "AWS::CloudFront::CloudFrontOriginAccessIdentity",
      "Properties": {
        "CloudFrontOriginAccessIdentityConfig": {
          "Comment": "versionator-ui static app"
        }
      }
    },
    "DefaultCloudfrontDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Aliases": [
            "versionator.data-dev.clearcollateral.com"
          ],
          "CustomErrorResponses": [
            {
              "ErrorCode": 403,
              "ResponseCode": 403,
              "ResponsePagePath": "/index.html"
            }
          ],
          "DefaultCacheBehavior": {
            "ForwardedValues": {
              "QueryString": true
            },
            "TargetOriginId": "development-clear-lake-versionator-ui",
            "ViewerProtocolPolicy": "redirect-to-https"
          },
          "DefaultRootObject": "index.html",
          "Enabled": true,
          "Logging": {
            "Bucket": {
              "Fn::Sub": "${S3AppLogBucket}.s3.amazonaws.com"
            },
            "Prefix": "versionator-ui-site-access-logs"
          },
          "Comment": "versionator-ui distribution",
          "Origins": [
            {
              "Id": "development-clear-lake-versionator-ui",
              "DomainName": "development-clear-lake-versionator-ui.s3.amazonaws.com",
              "S3OriginConfig": {
                "OriginAccessIdentity": {
                  "Fn::Sub": "origin-access-identity/cloudfront/${CloudFrontOriginAccessIdentity}"
                }
              }
            }
          ],
          "ViewerCertificate": {
            "AcmCertificateArn": "arn:aws:acm:us-east-1:758725036624:certificate/af706b0f-34e3-4880-becb-39f2ba354a2f",
            "SslSupportMethod": "sni-only"
          },
          "WebACLId": "arn:aws:wafv2:us-east-1:758725036624:global/webacl/StackSet-CC-WAF-IP-0fdde5ab-0926-42b0-b144-4ef32661d2ed-us-east-1-WAF/6ce3045d-9b02-43b0-8e84-2b261335fb92"
        }
      }
    },
    "CustomDomainRecordSet": {
      "Type": "AWS::Route53::RecordSetGroup",
      "Properties": {
        "HostedZoneId": "{{resolve:ssm:/data/dev/route53/hosted_zone/data-dev.clearcollateral.com:1}}",
        "RecordSets": [
          {
            "Name": "versionator.data-dev.clearcollateral.com",
            "Type": "A",
            "AliasTarget": {
              "DNSName": {
                "Fn::Join": [
                  "",
                  [
                    {
                      "Fn::GetAtt": [
                        "DefaultCloudfrontDistribution",
                        "DomainName"
                      ]
                    },
                    "."
                  ]
                ]
              },
              "HostedZoneId": "Z2FDTNDATAQYW2"
            }
          }
        ]
      }
    }
  },
  "Outputs": {
    "ServerlessDeploymentBucketName": {
      "Value": "development-clear-lake-sls-deploy"
    },
    "DefaultCloudfrontDistributionOutput": {
      "Value": {
        "Fn::GetAtt": [
          "DefaultCloudfrontDistribution",
          "DomainName"
        ]
      }
    }
  }
}